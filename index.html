<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poker Starting Hands Trainer</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html, body {
            height: 100%;
            height: 100dvh;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            /* Poker-table felt background */
            background-color: #0b3b24;
            background-image:
                radial-gradient(circle at 20% 15%, rgba(255, 255, 255, 0.10) 0, rgba(255, 255, 255, 0) 55%),
                radial-gradient(circle at 80% 85%, rgba(0, 0, 0, 0.6) 0, rgba(0, 0, 0, 0) 55%),
                repeating-radial-gradient(circle at 0 0, rgba(255, 255, 255, 0.04) 0, rgba(255, 255, 255, 0.04) 1px, rgba(0, 0, 0, 0.04) 1px, rgba(0, 0, 0, 0.04) 3px),
                linear-gradient(135deg, #1a472a 0%, #0d2818 100%);
            background-blend-mode: soft-light, multiply, normal, normal;
            background-size: 120% 120%, 140% 140%, 4px 4px, auto;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }
        .container {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 100%;
            max-height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            color: #1a472a;
            margin-bottom: 8px;
            font-size: 24px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 25px;
            font-size: 14px;
        }
        .score-board {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 10px;
        }
        .score-item { text-align: center; }
        .score-label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
        }
        .score-value {
            font-size: 20px;
            font-weight: bold;
            color: #1a472a;
        }
        .situation-box {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
        }
        .situation-title {
            font-size: 11px;
            color: #e65100;
            text-transform: uppercase;
            font-weight: bold;
            margin-bottom: 6px;
        }
        .situation-text {
            font-size: 15px;
            color: #333;
            line-height: 1.4;
        }
        .action-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 13px;
        }
        .action-fold { background: #ffebee; color: #c62828; }
        .action-call { background: #e3f2fd; color: #1565c0; }
        .action-raise { background: #e8f5e9; color: #2e7d32; }
        .position-display {
            text-align: center;
            margin-bottom: 12px;
            padding: 8px;
            background: #e8f5e9;
            border-radius: 8px;
        }
        .position-label { font-size: 12px; color: #666; }
        .position-name { font-size: 18px; font-weight: bold; color: #1a472a; }
        .game-info {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 12px;
            font-size: 13px;
            color: #666;
        }
        .game-info strong { color: #1a472a; }
        .cards-container {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        .card {
            width: 80px;
            height: 115px;
            background: white;
            border-radius: 10px;
            border: 2px solid #ddd;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .card.red { color: #d32f2f; }
        .card.black { color: #212121; }
        .card-rank { font-size: 26px; font-weight: bold; }
        .card-suit { font-size: 32px; }
        .buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        button {
            flex: 1;
            padding: 16px 15px;
            font-size: 17px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }
        @media (hover: hover) {
            button:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            }
        }
        button:active {
            transform: scale(0.97);
            opacity: 0.9;
        }
        .btn-raise { background: #4caf50; color: white; }
        .btn-call { background: #2196f3; color: white; }
        .btn-fold { background: #f44336; color: white; }
        .btn-back { background: #9e9e9e; color: white; flex: 0.5; }
        .sizing-panel {
            display: none;
            background: #f0f7f0;
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .sizing-title {
            text-align: center;
            font-size: 15px;
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 12px;
        }
        .sizing-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .sizing-btn {
            padding: 14px 12px;
            font-size: 15px;
            background: white;
            border: 2px solid #4caf50;
            color: #2e7d32;
            border-radius: 8px;
            min-height: 65px;
        }
        @media (hover: hover) {
            .sizing-btn:hover {
                background: #4caf50;
                color: white;
            }
            .sizing-btn:hover .label { color: #e8f5e9; }
        }
        .sizing-btn:active {
            background: #4caf50;
            color: white;
        }
        .sizing-btn:active .label { color: #e8f5e9; }
        .sizing-btn .amount { font-weight: bold; display: block; }
        .sizing-btn .label { font-size: 11px; color: #666; }
        .feedback {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
        }
        .feedback.correct { background: #e8f5e9; color: #2e7d32; }
        .feedback.incorrect { background: #ffebee; color: #c62828; }
        .feedback.partial { background: #fff3e0; color: #e65100; }
        .feedback-title { font-size: 20px; font-weight: bold; margin-bottom: 8px; }
        .feedback-subtitle { font-size: 13px; font-weight: bold; margin-bottom: 6px; }
        .feedback-explanation { font-size: 13px; line-height: 1.4; }
        .next-btn {
            width: 100%;
            background: #1a472a;
            color: white;
            display: none;
        }
        .hand-name {
            text-align: center;
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }
        .streak {
            text-align: center;
            font-size: 14px;
            color: #ff9800;
            margin-top: 8px;
        }
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        .welcome-overlay.hidden { display: none; }
        .welcome-box {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        .welcome-box h2 {
            color: #1a472a;
            margin-bottom: 15px;
            font-size: 24px;
        }
        .welcome-box p {
            color: #555;
            margin-bottom: 15px;
            line-height: 1.5;
            font-size: 15px;
        }
        .welcome-box .start-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .welcome-box .start-btn:active {
            transform: scale(0.97);
            opacity: 0.9;
        }
        .position-name {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
        }
        .info-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        .info-overlay.hidden { display: none; }
        .info-box {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 350px;
            width: 100%;
            text-align: center;
        }
        .info-box h3 {
            color: #1a472a;
            margin-bottom: 12px;
            font-size: 20px;
        }
        .info-box p {
            color: #555;
            line-height: 1.5;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .info-box .close-btn {
            background: #1a472a;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        /* Accessibility: Focus styles for all interactive elements */
        button:focus,
        .position-name:focus,
        .sizing-btn:focus,
        .start-btn:focus,
        .close-btn:focus {
            outline: 3px solid #1a472a;
            outline-offset: 2px;
        }

        /* High contrast focus for dark backgrounds */
        .welcome-overlay button:focus,
        .info-overlay button:focus {
            outline-color: #fff;
        }

        /* Media query for narrow screens - stack sizing buttons */
        @media (max-width: 320px) {
            .sizing-buttons {
                grid-template-columns: 1fr;
            }
        }

    </style>
</head>
<body>
    <div class="info-overlay hidden" id="position-info" role="dialog" aria-modal="true" aria-labelledby="info-title">
        <div class="info-box">
            <h3 id="info-title">Position</h3>
            <p id="info-text">Description</p>
            <button class="close-btn" id="close-info">Got it</button>
        </div>
    </div>

    <div class="welcome-overlay" id="welcome" role="dialog" aria-modal="true" aria-labelledby="welcome-title">
        <div class="welcome-box">
            <h2 id="welcome-title">Welcome!</h2>
            <p>Practice your Texas Hold'em pre-flop decisions. You'll see two cards and the action before you.</p>
            <p>Choose to <strong>Raise</strong>, <strong>Call</strong>, or <strong>Fold</strong> based on your hand and position.</p>
            <p>If you raise, pick the right size too!</p>
            <p><strong>Let's get that bag baby ðŸ’°</strong></p>
            <p style="margin-top: 20px; color: #888; font-style: italic;">- Katherine ðŸ’•</p>
            <button class="start-btn" id="start-btn">Let's Play</button>
        </div>
    </div>

    <main class="container">
        <h1>Starting Hands Trainer</h1>
        <p class="subtitle">Texas Hold'em Pre-Flop Decisions</p>

        <div class="score-board" aria-live="polite" aria-atomic="true">
            <div class="score-item">
                <div class="score-label">Correct</div>
                <div class="score-value" id="correct">0</div>
            </div>
            <div class="score-item">
                <div class="score-label">Total</div>
                <div class="score-value" id="total">0</div>
            </div>
            <div class="score-item">
                <div class="score-label">Accuracy</div>
                <div class="score-value" id="accuracy">0%</div>
            </div>
            <div class="score-item">
                <div class="score-label">Sizing</div>
                <div class="score-value" id="sizing-accuracy">-</div>
            </div>
        </div>

        <div class="situation-box">
            <div class="situation-title">Action Before You</div>
            <div class="situation-text" id="action-description">Everyone folds to you.</div>
        </div>

        <div class="position-display">
            <div class="position-label">Your Position</div>
            <div class="position-name" id="position" role="button" tabindex="0" aria-label="Your position: Button. Press Enter for details.">Button</div>
        </div>

        <div class="game-info">
            <div>Blinds: <strong>$5/$10</strong></div>
            <div>Pot: <strong id="pot-size">$15</strong></div>
            <div>To Call: <strong id="to-call">$10</strong></div>
        </div>

        <div class="cards-container">
            <div class="card" id="card1" role="img" aria-label="Ace of Spades">
                <div class="card-rank">A</div>
                <div class="card-suit">â™ </div>
            </div>
            <div class="card" id="card2" role="img" aria-label="King of Spades">
                <div class="card-rank">K</div>
                <div class="card-suit">â™ </div>
            </div>
        </div>

        <div class="hand-name" id="hand-name">Ace-King Suited</div>

        <div class="buttons" id="action-buttons">
            <button class="btn-raise" id="btn-raise">Raise</button>
            <button class="btn-call" id="btn-call">Call</button>
            <button class="btn-fold" id="btn-fold">Fold</button>
        </div>

        <div class="sizing-panel" id="sizing-panel">
            <div class="sizing-title">Choose Your Raise Size</div>
            <div class="sizing-buttons" id="sizing-buttons"></div>
            <div class="buttons" style="margin-top: 12px;">
                <button class="btn-back" id="btn-back">Back</button>
            </div>
        </div>

        <div class="feedback" id="feedback" role="alert" aria-live="assertive">
            <div class="feedback-title" id="feedback-title">Correct!</div>
            <div class="feedback-subtitle" id="feedback-subtitle"></div>
            <div class="feedback-explanation" id="feedback-explanation"></div>
        </div>

        <button class="next-btn" id="next-btn">Next Hand</button>

        <div class="streak" id="streak"></div>
    </main>

    <script>
        const ranks = ['2', '3', '4', '5', '6', '7', '8', '9', 'T', 'J', 'Q', 'K', 'A'];
        const suits = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
        const positions = ['UTG (First)', 'Middle', 'Cutoff', 'Button', 'Small Blind', 'Big Blind'];
        const BB = 10;

        let correct = 0, total = 0, sizingCorrect = 0, sizingTotal = 0, streak = 0;
        let currentHand = null, currentPosition = null, currentScenario = null;
        let correctAnswer = null, correctSizing = null;

        const scenarios = [
            { id: 'folded_to_you', description: 'No one has entered the pot yet. First to act.', raisesAhead: 0, callersAhead: 0, pot: 15, toCall: 10, lastRaise: 0 },
            { id: 'one_limper', description: '<span class="action-tag action-call">1 limper</span> called the big blind.', raisesAhead: 0, callersAhead: 1, pot: 25, toCall: 10, lastRaise: 0 },
            { id: 'two_limpers', description: '<span class="action-tag action-call">2 limpers</span> in front of you.', raisesAhead: 0, callersAhead: 2, pot: 35, toCall: 10, lastRaise: 0 },
            { id: 'one_raise', description: 'One player <span class="action-tag action-raise">raised to $30</span>.', raisesAhead: 1, callersAhead: 0, pot: 45, toCall: 30, lastRaise: 30 },
            { id: 'raise_and_caller', description: '<span class="action-tag action-raise">Raise to $30</span>, one <span class="action-tag action-call">caller</span>.', raisesAhead: 1, callersAhead: 1, pot: 75, toCall: 30, lastRaise: 30 },
            { id: 'three_bet', description: 'Raise to $30, then <span class="action-tag action-raise">re-raise to $90</span>.', raisesAhead: 2, callersAhead: 0, pot: 135, toCall: 90, lastRaise: 90 }
        ];

        const handRankings = {
            'AA': 1, 'KK': 1, 'QQ': 1, 'JJ': 2, 'TT': 2, '99': 3, '88': 3,
            '77': 4, '66': 4, '55': 4, '44': 4, '33': 4, '22': 4,
            'AKs': 1, 'AQs': 2, 'AJs': 2, 'ATs': 3, 'KQs': 2, 'KJs': 3, 'KTs': 3,
            'QJs': 3, 'QTs': 4, 'JTs': 3, 'J9s': 4, 'T9s': 4, 'T8s': 5,
            '98s': 4, '97s': 5, '87s': 4, '86s': 5, '76s': 4, '75s': 5,
            '65s': 4, '64s': 5, '54s': 4,
            'A9s': 4, 'A8s': 4, 'A7s': 4, 'A6s': 4, 'A5s': 4, 'A4s': 4, 'A3s': 4, 'A2s': 4,
            'K9s': 5, 'K8s': 5, 'Q9s': 5,
            'AKo': 2, 'AQo': 3, 'AJo': 3, 'ATo': 4, 'KQo': 3, 'KJo': 4, 'KTo': 5,
            'QJo': 4, 'QTo': 5, 'JTo': 4, 'A9o': 5, 'A8o': 5,
        };

        function getHandKey(rank1, rank2, suited) {
            const r1 = ranks.indexOf(rank1), r2 = ranks.indexOf(rank2);
            const high = r1 > r2 ? rank1 : rank2, low = r1 > r2 ? rank2 : rank1;
            if (high === low) return high + low;
            return high + low + (suited ? 's' : 'o');
        }

        function getHandName(rank1, rank2, suited) {
            const names = { 'A': 'Ace', 'K': 'King', 'Q': 'Queen', 'J': 'Jack', 'T': 'Ten', '9': 'Nine', '8': 'Eight', '7': 'Seven', '6': 'Six', '5': 'Five', '4': 'Four', '3': 'Three', '2': 'Two' };
            const r1 = ranks.indexOf(rank1), r2 = ranks.indexOf(rank2);
            const high = r1 > r2 ? rank1 : rank2, low = r1 > r2 ? rank2 : rank1;
            if (high === low) return `Pocket ${names[high]}s`;
            return `${names[high]}-${names[low]}${suited ? ' Suited' : ' Offsuit'}`;
        }

        const isLate = p => p === 'Button' || p === 'Cutoff';
        const isBlind = p => p === 'Small Blind' || p === 'Big Blind';

        function getPositionCategory(position) {
            if (position === 'UTG (First)') return 'utg';
            if (position === 'Middle') return 'middle';
            if (position === 'Cutoff') return 'co';
            if (position === 'Button') return 'btn';
            if (position === 'Small Blind') return 'sb';
            if (position === 'Big Blind') return 'bb';
            return 'middle';
        }

        function getCorrectAction(handKey, position, scenario) {
            const ranking = handRankings[handKey] || 5; // 1 = best, 5 = worst
            const { raisesAhead, callersAhead } = scenario;
            const posCat = getPositionCategory(position);

            // --- Multi-raise pots (3-bet/4-bet spots) ---
            if (raisesAhead >= 2) {
                // Very tight here from all positions
                if (ranking === 1) {
                    // Premiums 4-bet for value
                    return 'raise';
                }
                if (ranking === 2 && ['AKs', 'AKo', 'QQ', 'JJ'].includes(handKey)) {
                    // Some strong hands can call the 3-bet/4-bet
                    return 'call';
                }
                return 'fold';
            }

            // --- Single-raise pots (facing an open raise) ---
            if (raisesAhead === 1) {
                // Early position vs raise: very tight
                if (posCat === 'utg') {
                    if (ranking === 1) return 'raise';        // 3-bet premiums
                    if (ranking === 2 && ['AKs', 'AKo', 'QQ', 'JJ'].includes(handKey)) return 'call';
                    return 'fold';
                }

                // Middle position vs raise
                if (posCat === 'middle') {
                    if (ranking === 1) return 'raise';        // 3-bet
                    if (ranking === 2) return 'call';         // strong but not premiums
                    if (ranking === 3 && ['AKo', 'AQs', 'KQs'].includes(handKey)) return 'call';
                    return 'fold';
                }

                // Cutoff vs raise
                if (posCat === 'co') {
                    if (ranking === 1) return 'raise';
                    if (ranking === 2) return 'call';
                    if (ranking === 3) return 'call';
                    // Occasionally defend with some speculative suiteds
                    if (ranking === 4 && handKey.endsWith('s')) return 'call';
                    return 'fold';
                }

                // Button vs raise: widest defend
                if (posCat === 'btn') {
                    if (ranking === 1) return 'raise';
                    if (ranking === 2 || ranking === 3) return 'call';
                    if (ranking === 4 && handKey.endsWith('s')) return 'call'; // suited connectors/gappers sometimes
                    return 'fold';
                }

                // Small Blind vs raise: more 3-bet or fold, fewer flats
                if (posCat === 'sb') {
                    if (ranking === 1) return 'raise';
                    if (ranking === 2) return 'call';
                    // Occasionally defend playable suited hands
                    if (ranking === 3 && handKey.endsWith('s')) return 'call';
                    return 'fold';
                }

                // Big Blind vs raise: widest defend (already invested, good price)
                if (posCat === 'bb') {
                    if (ranking === 1) return 'raise';
                    if (ranking === 2 || ranking === 3) return 'call';
                    if (ranking === 4) return 'call'; // defend a lot in BB
                    return 'fold';
                }
            }

            // --- Limped pots (no raises, at least one caller) ---
            if (callersAhead > 0) {
                // Big Blind with limpers: free to check when no raise ahead
                if (posCat === 'bb') {
                    if (ranking <= 2) return 'raise'; // iso with strong hands
                    return 'call'; // otherwise take the free/cheap flop
                }

                // Small Blind with limpers
                if (posCat === 'sb') {
                    if (ranking <= 2) return 'raise';                    // iso with strong hands
                    if (ranking === 3 && callersAhead <= 2) return 'call'; // complete with decent hands
                    // Allow some strong offsuit aces like ATo to complete
                    if (handKey === 'ATo' && callersAhead === 1) return 'call';
                    return 'fold';
                }

                // UTG & Middle in limped pots (someone limped before you)
                if (posCat === 'utg' || posCat === 'middle') {
                    if (ranking <= 2) return 'raise'; // punish limpers with strong hands
                    if (ranking === 3) return 'call'; // set-mine / see flop with playable hands
                    return 'fold';
                }

                // CO & Button vs limpers: lots of iso-raising
                if (posCat === 'co' || posCat === 'btn') {
                    if (ranking <= 3) return 'raise';                     // iso frequently
                    if (ranking === 4 && callersAhead >= 2) return 'call'; // multi-way suited/speculative
                    return 'fold';
                }
            }

            // --- Unopened pots (everyone folds to you) ---
            if (callersAhead === 0 && raisesAhead === 0) {
                // UTG open range: tightest
                if (posCat === 'utg') {
                    if (ranking <= 2) return 'raise'; // strong + premium
                    if (ranking === 3 && ['AQo', 'AJs', 'KQs'].includes(handKey)) return 'raise';
                    return 'fold';
                }

                // Middle position: a bit wider than UTG
                if (posCat === 'middle') {
                    if (ranking <= 3) return 'raise';
                    if (ranking === 4 && handKey.endsWith('s')) return 'raise'; // some suited connectors
                    return 'fold';
                }

                // Cutoff: fairly wide but not total trash
                if (posCat === 'co') {
                    if (ranking <= 3) return 'raise';
                    // Only open the better speculative hands, not the absolute weakest
                    if (ranking === 4 && handKey.endsWith('s')) return 'raise';
                    return 'fold';
                }

                // Button: widest open range, but still fold true trash
                if (posCat === 'btn') {
                    if (ranking <= 3) return 'raise';
                    // Open the better speculative hands, especially suited ones
                    if (ranking === 4) return 'raise';
                    return 'fold';
                }

                // Small Blind unopened (everyone folds to SB)
                if (posCat === 'sb') {
                    if (ranking <= 3) return 'raise';                     // raise or steal
                    if (ranking === 4) return 'call';                     // complete with playable hands
                    return 'fold';
                }

                // Big Blind unopened shouldn't really happen (youâ€™re last to act),
                // but if it does, treat it like a free check / fold worst stuff.
                if (posCat === 'bb') {
                    if (ranking <= 4) return 'call';
                    return 'fold';
                }
            }

            // Fallback (should rarely hit)
            if (ranking <= 3) return 'raise';
            if (ranking === 4 && (posCat === 'co' || posCat === 'btn' || posCat === 'bb')) return 'call';
            return 'fold';
        }

        function getCorrectSizing(scenario, position) {
            const { raisesAhead, callersAhead, lastRaise } = scenario;
            const posCat = getPositionCategory(position);
            const oop = posCat === 'sb' || posCat === 'bb';

            let target;

            // Multi-raise pots (treat as 4-bet sizing over the last 3-bet)
            if (raisesAhead >= 2) {
                const factor = oop ? 2.75 : 2.5;
                target = lastRaise * factor;
            }
            // Facing a single raise (3-bet sizing)
            else if (raisesAhead === 1) {
                const factor = oop ? 3.5 : 3.0;
                target = lastRaise * factor;
            }
            // Limped pots: open size plus +1 BB per limper
            else if (callersAhead > 0) {
                const baseOpen = (oop ? 3.5 : 2.5) * BB;
                target = baseOpen + callersAhead * BB;
            }
            // Unopened pots: RFI
            else {
                target = (oop ? 3.5 : 2.5) * BB;
            }

            const amount = Math.round(target);
            return { amount, min: amount * 0.9, max: amount * 1.1 };
        }

        function getRaiseSizingOptions(scenario, position) {
            const cs = getCorrectSizing(scenario, position);
            const target = cs.amount;

            return [
                { amount: Math.round(target * 0.8), label: 'Small' },
                { amount: Math.round(target),      label: 'Standard' },
                { amount: Math.round(target * 1.2), label: 'Large' },
                { amount: Math.round(target * 1.6), label: 'Overbet' }
            ];
        }

        function addTapHandler(el, cb) {
            let moved = false;
            el.addEventListener('touchstart', () => moved = false, { passive: true });
            el.addEventListener('touchmove', () => moved = true, { passive: true });
            el.addEventListener('touchend', e => { if (!moved) { e.preventDefault(); cb(); } });
            el.addEventListener('click', () => { if (!('ontouchstart' in window)) cb(); });
        }

        // Keyboard handler for accessible buttons (Enter/Space activation)
        function addKeyboardHandler(el, cb) {
            el.addEventListener('keydown', e => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    cb();
                }
            });
        }

        // Focus trap for modal dialogs
        function trapFocus(modal) {
            const focusableEls = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            const firstFocusable = focusableEls[0];
            const lastFocusable = focusableEls[focusableEls.length - 1];

            if (firstFocusable) firstFocusable.focus();

            modal.addEventListener('keydown', e => {
                if (e.key === 'Tab') {
                    if (e.shiftKey && document.activeElement === firstFocusable) {
                        e.preventDefault();
                        lastFocusable.focus();
                    } else if (!e.shiftKey && document.activeElement === lastFocusable) {
                        e.preventDefault();
                        firstFocusable.focus();
                    }
                }
                if (e.key === 'Escape') {
                    if (!modal.classList.contains('hidden')) {
                        if (modal.id === 'position-info') hidePositionInfo();
                        if (modal.id === 'welcome') hideWelcome();
                    }
                }
            });
        }

        // Card name helper for aria-labels
        function getCardAriaLabel(rank, suit) {
            const rankNames = { 'A': 'Ace', 'K': 'King', 'Q': 'Queen', 'J': 'Jack', 'T': 'Ten', '9': 'Nine', '8': 'Eight', '7': 'Seven', '6': 'Six', '5': 'Five', '4': 'Four', '3': 'Three', '2': 'Two' };
            const suitNames = { 'â™ ': 'Spades', 'â™¥': 'Hearts', 'â™¦': 'Diamonds', 'â™£': 'Clubs' };
            return `${rankNames[rank] || rank} of ${suitNames[suit] || suit}`;
        }

        function showRaiseSizing() {
            document.getElementById('action-buttons').style.display = 'none';
            const panel = document.getElementById('sizing-panel');
            const btns = document.getElementById('sizing-buttons');
            btns.innerHTML = getRaiseSizingOptions(currentScenario, currentPosition).map(o =>
                `<button class=\"sizing-btn\" data-amount=\"${o.amount}\"><span class=\"amount\">$${o.amount}</span><span class=\"label\">${o.label}</span></button>`
            ).join('');
            btns.querySelectorAll('.sizing-btn').forEach(b => addTapHandler(b, () => makeDecision('raise', +b.dataset.amount)));
            panel.style.display = 'block';
        }

        function hideSizingPanel() {
            document.getElementById('sizing-panel').style.display = 'none';
            document.getElementById('action-buttons').style.display = 'flex';
        }

        function getExplanation(handKey, position, scenario, action, ranking) {
            const strength = ['','premium','strong','playable','speculative','weak'][ranking] || 'weak';
            const { raisesAhead, callersAhead } = scenario;
            const posCat = getPositionCategory(position);

            const posLabel = {
                utg: 'early position (UTG)',
                middle: 'middle position',
                co: 'the cutoff',
                btn: 'the button',
                sb: 'the small blind',
                bb: 'the big blind'
            }[posCat] || 'this position';

            // Helper snippets
            const openLine = () => `From ${posLabel}, you should open-raise this ${strength} hand.`;
            const foldLine = () => `This ${strength} hand is too weak to continue from ${posLabel} in this spot.`;
            const callLine = () => `Calling is reasonable with this ${strength} hand from ${posLabel}.`;
            const isoLine  = () => `Raising to isolate the limpers with this ${strength} hand from ${posLabel} is preferred.`;

            // --- Multi-raise pots (3-bet / 4-bet spots) ---
            if (raisesAhead >= 2) {
                if (action === 'raise') {
                    return `Youâ€™re in a heavily contested pot (3-bet/4-bet already). With a ${strength} hand, continuing aggressively for value is correct here from ${posLabel}.`;
                }
                if (action === 'call') {
                    return `Facing multiple raises, this ${strength} hand is just strong enough to continue by calling from ${posLabel}, but not strong enough to 4-bet for value.`;
                }
                return `With multiple raises already in, ${strength} hands like this are usually folded from ${posLabel} unless theyâ€™re premium.`;
            }

            // --- Single-raise pots (facing an open raise) ---
            if (raisesAhead === 1) {
                if (action === 'raise') {
                    return `Facing a single raise, this ${strength} hand is strong enough to 3-bet for value from ${posLabel}, putting pressure on the opener and building the pot when ahead.`;
                }
                if (action === 'call') {
                    if (posCat === 'bb') {
                        return `Youâ€™re in the big blind facing a raise. Given the price youâ€™re getting and your ${strength} hand, defending by calling is standard.`;
                    }
                    if (posCat === 'sb') {
                        return `From the small blind facing a raise, this ${strength} hand is just good enough to continue by calling, even though youâ€™ll be out of position postflop.`;
                    }
                    if (posCat === 'btn' || posCat === 'co') {
                        return `With position and a ${strength} hand, calling the raise from ${posLabel} keeps the pot manageable and lets you realize your positional advantage.`;
                    }
                    return `From ${posLabel} versus a single raise, this ${strength} hand is good enough to call but not strong enough to 3-bet aggressively.`;
                }
                return `Facing a raise from ${posLabel}, this ${strength} hand is not profitable to continue with. Folding avoids getting involved with a dominated or difficult hand out of position.`;
            }

            // --- Limped pots (no raises, at least one caller) ---
            if (callersAhead > 0) {
                if (action === 'raise') {
                    if (posCat === 'btn' || posCat === 'co') {
                        return `One or more players have limped. From ${posLabel}, itâ€™s strong to raise this ${strength} hand to isolate the limpers and take advantage of your position.`;
                    }
                    if (posCat === 'bb') {
                        return `Several players have entered the pot cheaply. From the big blind with a ${strength} hand, raising to punish the limpers and build a pot with a likely edge is correct.`;
                    }
                    return `${isoLine()} You punish limpers, build the pot when ahead, and deny equity to weaker hands.`;
                }
                if (action === 'call') {
                    if (posCat === 'bb') {
                        return `With limpers and no raise, youâ€™re in the big blind getting a free or very cheap look at the flop. Checking/calling with this ${strength} hand is standard here.`;
                    }
                    if (posCat === 'sb') {
                        return `In the small blind facing limpers, completing with this ${strength} hand is fine: youâ€™re getting good odds to see a flop, even though youâ€™ll be out of position.`;
                    }
                    return `With limpers already in, calling from ${posLabel} with this ${strength} hand is okay: youâ€™re seeing a multi-way flop at a good price with a playable holding.`;
                }
                return `Even in a limped pot, this ${strength} hand is too weak from ${posLabel}. Folding avoids playing trash out of position in a multi-way pot.`;
            }

            // --- Unopened pots (everyone folds to you) ---
            if (raisesAhead === 0 && callersAhead === 0) {
                if (action === 'raise') {
                    if (posCat === 'utg') {
                        return `Everyone has folded to you in early position. UTG requires the tightest opening range, and this ${strength} hand is just strong enough to open-raise profitably.`;
                    }
                    if (posCat === 'middle') {
                        return `In middle position with no one yet in the pot, this ${strength} hand is good enough to open-raise. You still need to be somewhat tight, but can play wider than UTG.`;
                    }
                    if (posCat === 'co') {
                        return `Folded to you in the cutoff, you can open fairly wide. This ${strength} hand is comfortably within a reasonable opening range from ${posLabel}.`;
                    }
                    if (posCat === 'btn') {
                        return `On the button with everyone folding to you, you should open-raise very aggressively. This ${strength} hand is an easy open given your positional advantage.`;
                    }
                    if (posCat === 'sb') {
                        return `Everyone has folded to your small blind. Raising with this ${strength} hand applies pressure to the big blind and can often pick up the pot uncontested.`;
                    }
                    // BB "unopened" is weird but treat it simply:
                    return `With everyone folding to you and this ${strength} hand, taking the initiative and raising from ${posLabel} is acceptable.`;
                }
                if (action === 'call') {
                    if (posCat === 'sb') {
                        return `Everyone folds to your small blind. Completing with this ${strength} hand is fine: you invest a little more to see a flop, while keeping the pot small.`;
                    }
                    if (posCat === 'bb') {
                        return `As the big blind in an unopened pot, youâ€™re effectively checking your option. With this ${strength} hand thereâ€™s no need to build a bigger pot out of position.`;
                    }
                    return `Calling instead of raising keeps the pot small, but from ${posLabel} you usually either raise or fold preflop; flatting here is a more conservative line.`;
                }
                return foldLine();
            }

            // --- Fallback (should rarely be hit) ---
            if (action === 'raise') return openLine();
            if (action === 'call') return callLine();
            return foldLine();
        }

        function getSizingExplanation(scenario, chosen, correct, position) {
            const { raisesAhead, callersAhead } = scenario;
            const posCat = getPositionCategory(position);
            const oop = posCat === 'sb' || posCat === 'bb';
            let base = '';

            if (raisesAhead >= 2) {
                const mult = oop ? '2.75x' : '2.5x';
                base = `4-bet to ~$${Math.round(correct.amount)} (${mult} the 3-bet).`;
            } else if (raisesAhead === 1) {
                const mult = oop ? '3.5x' : '3x';
                base = `3-bet to ~$${Math.round(correct.amount)} (${mult} the raise).`;
            } else if (callersAhead > 0) {
                const openMult = oop ? '3.5x' : '2.5x';
                base = `Raise to ~$${Math.round(correct.amount)} (open ${openMult} BB + 1 BB per limper).`;
            } else {
                const openMult = oop ? '3.5x' : '2.5x';
                base = `Open to ~$${Math.round(correct.amount)} (${openMult} BB).`;
            }

            if (chosen < correct.min) return base + ' Your bet was too small.';
            if (chosen > correct.max) return base + ' Your bet was too large.';
            return base;
        }
        function makeDecision(action, size) {
            total++;
            const actionOk = action === correctAnswer;
            let sizeOk = true;
            if (action === 'raise') {
                sizingTotal++;
                const cs = getCorrectSizing(currentScenario, currentPosition);
                sizeOk = size >= cs.min && size <= cs.max;
                if (sizeOk) sizingCorrect++;
            }
            const allOk = actionOk && (action !== 'raise' || sizeOk);
            if (allOk) { correct++; streak++; } else streak = 0;

            document.getElementById('correct').textContent = correct;
            document.getElementById('total').textContent = total;
            document.getElementById('accuracy').textContent = Math.round(correct/total*100) + '%';
            document.getElementById('sizing-accuracy').textContent = sizingTotal > 0 ? Math.round(sizingCorrect/sizingTotal*100) + '%' : '-';

            const fb = document.getElementById('feedback');
            const cs = getCorrectSizing(currentScenario, currentPosition);
            const ranking = handRankings[currentHand.handKey] || 5;

            if (allOk) {
                fb.className = 'feedback correct';
                document.getElementById('feedback-title').textContent = 'Correct!';
                document.getElementById('feedback-subtitle').textContent = '';
            } else if (actionOk) {
                fb.className = 'feedback partial';
                document.getElementById('feedback-title').textContent = 'Right Action, Wrong Size';
                document.getElementById('feedback-subtitle').textContent = `You bet $${size}, optimal is ~$${Math.round(cs.amount)}`;
            } else {
                fb.className = 'feedback incorrect';
                document.getElementById('feedback-title').textContent = 'Incorrect';
                document.getElementById('feedback-subtitle').textContent = correctAnswer.charAt(0).toUpperCase() + correctAnswer.slice(1) + ' was better';
            }

            let exp = getExplanation(currentHand.handKey, currentPosition, currentScenario, correctAnswer, ranking);
            // Only show sizing explanation if raise was correct AND user raised
            if (action === 'raise' && correctAnswer === 'raise') {
                exp += ' ' + getSizingExplanation(currentScenario, size, cs, currentPosition);
            }
            document.getElementById('feedback-explanation').textContent = exp;

            fb.style.display = 'block';
            document.getElementById('action-buttons').style.display = 'none';
            document.getElementById('sizing-panel').style.display = 'none';
            document.getElementById('next-btn').style.display = 'block';
            document.getElementById('streak').textContent = streak >= 3 ? 'ðŸ”¥ ' + streak + ' in a row!' : '';
        }

        function dealHand() {
            // Deal 2 unique cards - pick first card, then pick second ensuring it's different
            const r1 = ranks[Math.floor(Math.random() * 13)];
            const s1 = suits[Math.floor(Math.random() * 4)];

            // Keep picking second card until it's different from first
            let r2, s2;
            do {
                r2 = ranks[Math.floor(Math.random() * 13)];
                s2 = suits[Math.floor(Math.random() * 4)];
            } while (r1 === r2 && s1 === s2);

            const suited = s1 === s2;
            currentHand = { rank1: r1, rank2: r2, suit1: s1, suit2: s2, handKey: getHandKey(r1,r2,suited), suited };
            currentPosition = positions[Math.random()*6|0];
            currentScenario = scenarios[Math.random()*6|0];
            // Position-appropriate scenarios
            // UTG is first to act - can only have "no action yet"
            if (currentPosition === 'UTG (First)') {
                currentScenario = scenarios[0];
            }
            // Small Blind: if "no action" it means everyone folded to them - they can steal, complete, or fold
            // Middle position: could have UTG fold or act
            // Cutoff/Button: could have various actions
            // Big Blind: can't have "no action" - at minimum SB is in. Change to limper scenario.
            if (currentPosition === 'Big Blind' && currentScenario.id === 'folded_to_you') {
                currentScenario = scenarios[1]; // At least 1 limper
            }
            correctAnswer = getCorrectAction(currentHand.handKey, currentPosition, currentScenario);

            const c1 = document.getElementById('card1'), c2 = document.getElementById('card2');
            c1.innerHTML = `<div class="card-rank">${r1}</div><div class="card-suit">${s1}</div>`;
            c2.innerHTML = `<div class="card-rank">${r2}</div><div class="card-suit">${s2}</div>`;
            c1.className = 'card ' + (s1==='â™¥'||s1==='â™¦' ? 'red' : 'black');
            c2.className = 'card ' + (s2==='â™¥'||s2==='â™¦' ? 'red' : 'black');
            // Accessibility: add aria-labels to cards
            c1.setAttribute('aria-label', getCardAriaLabel(r1, s1));
            c2.setAttribute('aria-label', getCardAriaLabel(r2, s2));

            const posEl = document.getElementById('position');
            posEl.textContent = currentPosition;
            posEl.setAttribute('aria-label', `Your position: ${currentPosition}. Press Enter for details.`);
            document.getElementById('hand-name').textContent = getHandName(r1, r2, suited);
            // Adjust description for Small Blind when everyone folded
            let description = currentScenario.description;
            if (currentPosition === 'Small Blind' && currentScenario.id === 'folded_to_you') {
                description = 'Everyone folded to you in the small blind.';
            }

            // Add spot-type label (RFI / Facing RFI / RFI vs 3-bet / vs limpers)
            const { raisesAhead, callersAhead } = currentScenario;
            let spotLabel = '';
            if (raisesAhead >= 2) {
                spotLabel = 'RFI vs 3-bet';
            } else if (raisesAhead === 1) {
                spotLabel = 'Facing RFI';
            } else if (callersAhead > 0) {
                spotLabel = 'Versus limpers';
            } else {
                spotLabel = 'Raise First In (RFI)';
            }

            document.getElementById('action-description').innerHTML = `<strong>${spotLabel}:</strong> ` + description;
            document.getElementById('pot-size').textContent = '$' + currentScenario.pot;
            // Calculate correct "to call" amount based on position
            let toCall = currentScenario.toCall;
            const isFreeCheck = currentPosition === 'Big Blind' && currentScenario.raisesAhead === 0;
            if (isFreeCheck) {
                toCall = 0; // BB with no raise = free check
            } else if (currentPosition === 'Small Blind' && currentScenario.raisesAhead === 0) {
                toCall = 5; // SB already posted $5, only needs $5 more to complete
            } else if (currentPosition === 'Small Blind' && currentScenario.raisesAhead > 0) {
                toCall = currentScenario.toCall - 5; // SB already has $5 in
            } else if (currentPosition === 'Big Blind' && currentScenario.raisesAhead > 0) {
                toCall = currentScenario.toCall - 10; // BB already has $10 in
            }
            document.getElementById('to-call').textContent = '$' + toCall;

            // Update button text and hide fold when it's a free check
            document.getElementById('btn-call').textContent = isFreeCheck ? 'Check' : 'Call';
            document.getElementById('btn-fold').style.display = isFreeCheck ? 'none' : 'flex';

            document.getElementById('feedback').style.display = 'none';
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('sizing-panel').style.display = 'none';
            document.getElementById('action-buttons').style.display = 'flex';
        }

        // Position descriptions
        const positionInfo = {
            'UTG (First)': {
                title: 'UTG (Under the Gun)',
                text: 'First to act after the blinds. This is the tightest position - you need strong hands because everyone acts after you. Play only premium hands here.'
            },
            'Middle': {
                title: 'Middle Position',
                text: 'Between early and late position. You can play a few more hands than UTG, but still be selective. You have some players behind you who could raise.'
            },
            'Cutoff': {
                title: 'Cutoff (CO)',
                text: 'One seat before the Button. A strong position - you can open wider since only the Button and blinds act after you. Great for stealing blinds.'
            },
            'Button': {
                title: 'Button / Dealer (BTN)',
                text: 'The dealer position and the best seat at the table! You act last after the flop, giving you maximum information. Play the widest range here and be aggressive.'
            },
            'Small Blind': {
                title: 'Small Blind (SB)',
                text: 'You post half the big blind and act second-to-last preflop, but first after the flop. Tough position - be selective but defend against steals.'
            },
            'Big Blind': {
                title: 'Big Blind (BB)',
                text: 'You already have a full bet in. Last to act preflop, which is good, but out of position after the flop. Defend wider since you\'re getting a discount.'
            }
        };

        function showPositionInfo() {
            const pos = currentPosition;
            const info = positionInfo[pos];
            if (info) {
                lastFocusedElement = document.activeElement;
                document.getElementById('info-title').textContent = info.title;
                document.getElementById('info-text').textContent = info.text;
                const overlay = document.getElementById('position-info');
                overlay.classList.remove('hidden');
                // Hide main content from screen readers when dialog is open
                document.querySelector('main').setAttribute('aria-hidden', 'true');
                // Focus the close button for accessibility
                document.getElementById('close-info').focus();
            }
        }

        function hidePositionInfo() {
            document.getElementById('position-info').classList.add('hidden');
            // Restore main content to screen readers
            document.querySelector('main').removeAttribute('aria-hidden');
            // Restore focus to element that opened the dialog
            if (lastFocusedElement) {
                lastFocusedElement.focus();
                lastFocusedElement = null;
            }
        }

        // Welcome popup
        function showWelcome() {
            if (!localStorage.getItem('poker-trainer-visited')) {
                const overlay = document.getElementById('welcome');
                overlay.classList.remove('hidden');
                // Hide main content from screen readers when dialog is open
                document.querySelector('main').setAttribute('aria-hidden', 'true');
                // Focus the start button for accessibility
                setTimeout(() => document.getElementById('start-btn').focus(), 100);
            } else {
                document.getElementById('welcome').classList.add('hidden');
            }
        }

        function hideWelcome() {
            document.getElementById('welcome').classList.add('hidden');
            localStorage.setItem('poker-trainer-visited', 'true');
            // Restore main content to screen readers
            document.querySelector('main').removeAttribute('aria-hidden');
            // Focus the first action button after welcome closes
            document.getElementById('btn-raise').focus();
        }

        // Store reference to element that opened dialog, for focus restoration
        let lastFocusedElement = null;

        // Init
        addTapHandler(document.getElementById('btn-raise'), showRaiseSizing);
        addTapHandler(document.getElementById('btn-call'), () => makeDecision('call', 0));
        addTapHandler(document.getElementById('btn-fold'), () => makeDecision('fold', 0));
        addTapHandler(document.getElementById('btn-back'), hideSizingPanel);
        addTapHandler(document.getElementById('next-btn'), () => dealHand());
        addTapHandler(document.getElementById('start-btn'), hideWelcome);
        addTapHandler(document.getElementById('position'), showPositionInfo);
        addTapHandler(document.getElementById('close-info'), hidePositionInfo);

        // Add keyboard support for position name (CRITICAL accessibility fix)
        addKeyboardHandler(document.getElementById('position'), showPositionInfo);

        // Initialize focus traps for dialogs
        trapFocus(document.getElementById('position-info'));
        trapFocus(document.getElementById('welcome'));

        showWelcome();
        dealHand();
    </script>
</body>
</html>
